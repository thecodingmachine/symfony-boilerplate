"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[236],{1554:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>d,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>c});var s=n(5893),o=n(1151);const r={},d="Prod Deployment",a={id:"CICD",title:"Prod Deployment",description:"@see LINK TODO../gitlab-ci/gitlab-ci-tags-prod.yml",source:"@site/docs/CICD.md",sourceDirName:".",slug:"/CICD",permalink:"/symfony-boilerplate/v2/docs/CICD",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CICD.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Translate your site",permalink:"/symfony-boilerplate/v2/docs/tutorial-extras/translate-your-site"}},i={},c=[{value:"Prepare a demo server",id:"prepare-a-demo-server",level:2}];function l(e){const t=Object.assign({h1:"h1",p:"p",pre:"pre",code:"code",h2:"h2"},(0,o.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"prod-deployment",children:"Prod Deployment"}),"\n",(0,s.jsx)(t.p,{children:"@see LINK TODO../gitlab-ci/gitlab-ci-tags-prod.yml"}),"\n",(0,s.jsx)(t.p,{children:"This happen only when tag are pushed with format x.x.x"}),"\n",(0,s.jsx)(t.p,{children:"A production image is pushed to the tag then the gitlabci deploy it on the server"}),"\n",(0,s.jsx)(t.p,{children:"In gitlab, a variable named PROD_SSH_PRIVATE_KEY shall be added. It shall be encoded as base64\nThe public key shall be added into the server"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'TMPDIR="$(mktemp -d)" && ssh-keygen -t ed25519 -q -N "" -C "gitlab@git.thecodingmachine.com" -f "${TMPDIR}/id_ed25519" && echo -e "Private as base64 :\\n$(cat "${TMPDIR}/id_ed25519" | base64)\\nPublic :\\n$(cat "${TMPDIR}/id_ed25519.pub")" && rm -f "${TMPDIR}/id_ed25519"* && rmdir "${TMPDIR}"\n'})}),"\n",(0,s.jsx)(t.p,{children:"As best practice, add the public key into gitlab variable so it is not lost"}),"\n",(0,s.jsx)(t.h2,{id:"prepare-a-demo-server",children:"Prepare a demo server"}),"\n",(0,s.jsx)(t.p,{children:"These steps are basis steps, it should be good enough for a demonstration environnement"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"cd /\nsudo mkdir  tcm_deployment\nsudo chown ubuntu:ubuntu tcm_deployment\ncd tcm_deployment/\nssh-keygen -t ed25519\ncat ~/.ssh/id_ed25519.pub\n"})}),"\n",(0,s.jsx)(t.p,{children:"Ajouter la cl\xe9 dans Settings > repository > deploy key"}),"\n",(0,s.jsx)(t.p,{children:"Install docker dependencies"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'cd /tcm_deployment\ngit clone git@git.thecodingmachine.com:tcm-projects/analysec-app.git \nsudo apt-get update\nsudo apt-get install     ca-certificates     curl     gnupg     lsb-release\nsudo mkdir -p /etc/apt/keyrings\ncurl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg\necho   "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\\n  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\nsudo apt-get update\nsudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin\nsudo docker run hello-world\nsudo apt  install docker-compose\nsudo apt install make\ncp .env.dist .env\ncp docker-compose.override.yml.template  docker-compose.override.yml\n\nsudo groupadd docker \nsudo usermod -aG docker $USER\n'})}),"\n",(0,s.jsx)(t.p,{children:"To finish, Create a deploy token (NOT a key) named gitlab-deploy-token"}),"\n",(0,s.jsx)(t.p,{children:"After that, add the server IP into the gitlab-ci.yml"}),"\n",(0,s.jsx)(t.p,{children:"Then, on GIT tag, it should deploy"})]})}const p=function(e={}){const{wrapper:t}=Object.assign({},(0,o.ah)(),e.components);return t?(0,s.jsx)(t,Object.assign({},e,{children:(0,s.jsx)(l,e)})):l(e)}},1151:(e,t,n)=>{n.d(t,{Zo:()=>a,ah:()=>r});var s=n(7294);const o=s.createContext({});function r(e){const t=s.useContext(o);return s.useMemo((()=>"function"==typeof e?e(t):{...t,...e}),[t,e])}const d={};function a({components:e,children:t,disableParentContext:n}){let a;return a=n?"function"==typeof e?e({}):e||d:r(e),s.createElement(o.Provider,{value:a},t)}}}]);